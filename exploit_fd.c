#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<errno.h>
#include<sys/types.h>
#include<fcntl.h>

#define OFFSET_FD_TABLE 0x30
#define OFFSET_CONN_TABLE 0x10
#define POINTER_SIZE 4

/**
 * Returns the path for the file in the current directory
 * NOTE: Just a string-concat function, doesn't check for existence
 */
char* get_path(char* dir_path, char* file) {
    size_t dir_path_len = strlen(dir_path);
    size_t file_len = strlen(file);
    char* path = malloc(dir_path_len + file_len + 1);
    strcpy(path, dir_path);
    strcpy(path + dir_path_len, file);
    return path;
}

/**
 * Printing a byte buffer
 */
void print_byte_buffer(void* data_buffer, size_t buffer_size) {
    char* data = (char*) data_buffer;
    char buffer[2*buffer_size + 1];
    buffer[2*buffer_size] = 0;
    for(size_t j = 0; j < buffer_size; j++)
        sprintf(&buffer[2*j], "%02X", (unsigned char) data[j]);

    printf("buffer contents: %s\n", buffer);
}

/**
 * puts contents in buffer
 * Returns file pointer for open file
 */
int copy_bytes_from_raw(char* path, char* buffer, off_t offset) {
    // Open .raw file
    char* raw_file_path = get_path(path, "/.raw");
    int fd_raw = open(raw_file_path, O_RDWR);
    printf(".raw file opened: %s\n", raw_file_path);
    free(raw_file_path);

    // Copy the correct bytes
    lseek(fd_raw, offset, SEEK_SET);
    read(fd_raw, buffer, POINTER_SIZE);
    print_byte_buffer(buffer, POINTER_SIZE);
    return fd_raw;
}

/**
 * NOTE: raw_io must be enabled in peek for seek to work!
 */
int main(int argc, char** argv) {
    // Passed two arguments, fd_left and fd_right
    char* fd_path_left = argv[1];
    char* fd_path_right = argv[2];
    int status = 0;
    ssize_t num_read;
    
    /* 
     * Replacing bytes in TCP_FD_TABLE
     */
    // pointer to conn directories found in fd/.raw
    char conn_pointer_left[POINTER_SIZE] = {0};
    char conn_pointer_right[POINTER_SIZE] = {0};    
    
    printf("----------------fd_raw_left-------------\n");
    // Retrieving bytes & .raw file descriptor for FD lhs
    int fd_raw_left = copy_bytes_from_raw(fd_path_left, conn_pointer_left, OFFSET_FD_TABLE);
    // Retrieve file info
    char* conn_link_left = get_path(fd_path_left, "/tf_conn");
    char* conn_path_left = realpath(conn_link_left, NULL);
    printf("tf_conn -> %s\n", conn_path_left);
    free(conn_link_left);
    
    printf("----------------fd_raw_right-------------\n");
    // Retrieving bytes & .raw file descriptor for FD rhs
    int fd_raw_right = copy_bytes_from_raw(fd_path_right, conn_pointer_right, OFFSET_FD_TABLE);
    // Retrieve file info
    char* conn_link_right = get_path(fd_path_right, "/tf_conn");
    char* conn_path_right = realpath(conn_link_right, NULL);
    printf("tf_conn -> %s\n", conn_path_right);
    free(conn_link_right);

    // replacing pointers
    lseek(fd_raw_left, OFFSET_FD_TABLE, SEEK_SET);
    write(fd_raw_left, conn_pointer_right, POINTER_SIZE);

    lseek(fd_raw_right, OFFSET_FD_TABLE, SEEK_SET);
    write(fd_raw_right, conn_pointer_left, POINTER_SIZE);

    close(fd_raw_left);
    close(fd_raw_right);

    /*
     * Replacing bytes in TCP_CONN_TABLE
     */
    char fd_pointer_left[POINTER_SIZE] = {0};
    char fd_pointer_right[POINTER_SIZE] = {0};

    printf("----------------conn_raw_left-------------\n");
    // Retrieving bytes & file descriptor for CONN lhs
    int conn_raw_left = copy_bytes_from_raw(conn_path_left, fd_pointer_left, OFFSET_CONN_TABLE);
    printf("----------------conn_raw_right-------------\n");
    // Retrieving bytes & file descriptor for CONN rhs
    int conn_raw_right = copy_bytes_from_raw(conn_path_right, fd_pointer_right, OFFSET_CONN_TABLE);

    // replacing pointers
    lseek(conn_raw_left, OFFSET_CONN_TABLE, SEEK_SET);
    write(conn_raw_left, fd_pointer_right, POINTER_SIZE);

    lseek(conn_raw_right, OFFSET_CONN_TABLE, SEEK_SET);
    write(conn_raw_right, fd_pointer_left, POINTER_SIZE);

    close(conn_raw_left);
    close(conn_raw_right);
}
